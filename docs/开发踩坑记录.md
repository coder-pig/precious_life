# 开发踩坑记录

## 2025.05.22

### geolocator获取定位问题

**问题描述**

> 使用 geolocator 插件调用 getCurrentPosition() 方法时一直获取不到定位信息，并且出现以下警告:

```bash
W/GooglePlayServicesUtil(7067): com.example.precious_life requires the Google Play Store, but it is missing.
```

**问题解决**

> 设置超时，添加异常捕获，调用 getLastKnownPosition() 获取上次获取的位置

```dart
static Future<Position> getCurrentPosition() async {
    // 检查位置服务是否开启
    bool serviceEnabled = await Geolocator.isLocationServiceEnabled();
    if (!serviceEnabled) {
      throw '位置服务未开启';
    }

    // 检查应用权限
    LocationPermission permission = await Geolocator.checkPermission();
    if (permission == LocationPermission.denied) {
      permission = await Geolocator.requestPermission();
      if (permission == LocationPermission.denied) {
        throw '位置权限被拒绝';
      }
    }
    
    if (permission == LocationPermission.deniedForever) {
      throw '位置权限被永久拒绝，请在设置中启用';
    }

    // 配置位置设置，包括高精度和10秒超时
    const LocationSettings locationSettings = LocationSettings(
      accuracy: LocationAccuracy.high,
      timeLimit: Duration(seconds: 10),
    );

    // 获取当前位置
    try {
      return await Geolocator.getCurrentPosition(
        locationSettings: locationSettings,
      );
    } catch (e) {
      print("获取当前位置失败: ${e.toString()}");
      // 如果获取当前位置失败，尝试获取上次已知位置
      final lastPosition = await getLastKnownPosition();
      if (lastPosition != null) {
        return lastPosition;
      }
      // 如果上次位置也获取不到，则抛出异常
      throw '无法获取位置信息: ${e.toString()}';
    }
  }
```

### freezed 反序列化字段丢失

**问题描述**

> 使用@freezed定义实体类，发现在转换成对象时有些字段会丢失值，明明字段类型都是对的：

```dart
/// 类
@freezed
class QweatherNow with _$QweatherNow {
  const factory QweatherNow({
    /// 数据观测时间
    String? obsTime,

    /// 温度，默认单位：摄氏度
    String? temp,

    /// 体感温度，默认单位：摄氏度
    String? feelsLike,

    /// 天气状况的图标代码
    String? icon,

    /// 天气状况的文字描述，包括阴晴雨雪等天气状态的描述
    String? text,

    /// 风向360角度
    String? wind360,

    /// 风向
    String? windDir,

    /// 风力等级
    String? windScale,

    /// 风速，公里/小时
    String? windSpeed,

    /// 相对湿度，百分比数值
    String? humidity,

    /// 过去1小时降水量，默认单位：毫米
    String? precip,

    /// 大气压强，默认单位：百帕
    String? pressure,

    /// 能见度，默认单位：公里
    String? vis,

    /// 云量，百分比数值。可能为空
    String? cloud,

    /// 露点温度。可能为空
    String? dew,
  }) = _QweatherNow;

  factory QweatherNow.fromJson(Map<String, dynamic> json) => _$QweatherNowFromJson(json);
}

/// 打印生成对象的值
weatherData.now QweatherNow(obsTime: null, temp: 32, feelsLike: null, icon: 100, text: 晴, wind360: 200, windDir: null, windScale: null, windSpeed: null, humidity: 63, precip: 0.0, pressure: 1001, vis: null, cloud: 22, dew: 24)

/// 后台接口返回的数据
{"obsTime":"2025-05-22T07:00+00:00","temp":"32","feelsLike":"33","icon":"100","text":"晴","wind360":"200","windDir":"西南偏南风","windScale":"3","windSpeed":"17","humidity":"63","precip":"0.0","pressure":"1001","cloud":"22","dew":"24"}
```

**问题解决**

> 🐶 AI 生成的 build.yaml 中关于 json_serializable 库的配置，加了一个【field_rename: snake】，它会：自动把 Dart 类的字段名（通常是驼峰命名法，比如 obsTime、feelsLike）在序列化和反序列化 JSON 时，转换为 蛇形命名（比如 obs_time、feels_like），有毒，我擦。